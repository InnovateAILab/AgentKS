{% extends "base.html" %}
{% set title = "LLMs" %}
{% block content %}
<div class="container">
  <div class="flex items-end justify-between gap-3 flex-wrap mb-4">
    <div>
      <h1 class="h1">Large Language Models</h1>
      <p class="p-muted">Manage available LLMs and their configuration.</p>
    </div>
    <a href="/admin/llms/add" class="btn btn-primary">Add LLM</a>
  </div>

  <div class="card card-pad" style="margin-bottom:12px;">
    <form method="get" class="grid grid-3">
      <div>
        <label class="block mb-1 text-xs font-medium text-gray-700">Search</label>
        <input name="q" value="{{ filters.q }}" placeholder="name or model..." class="input">
      </div>
      <div>
        <label class="block mb-1 text-xs font-medium text-gray-700">Provider</label>
        <select name="provider" class="input">
          <option value="all" {{ "selected" if filters.provider=="all" else "" }}>all</option>
          {% for p in providers %}
          <option value="{{ p }}" {{ "selected" if filters.provider==p else "" }}>{{ p }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="block mb-1 text-xs font-medium text-gray-700">Enabled</label>
        <select name="enabled" class="input">
          <option value="all" {{ "selected" if filters.enabled=="all" else "" }}>all</option>
          <option value="true" {{ "selected" if filters.enabled=="true" else "" }}>enabled</option>
          <option value="false" {{ "selected" if filters.enabled=="false" else "" }}>disabled</option>
        </select>
      </div>

      <div class="sm:col-span-3 flex gap-2">
        <button class="btn btn-primary">Apply</button>
        <a href="/admin/llms" class="btn">Reset</a>
      </div>
    </form>
  </div>

  <div class="card tablewrap">
    <form method="post" action="/admin/llms/bulk" id="bulkLlmForm" onsubmit="return handleBulkSubmit(event)">
      <div class="flex items-center justify-between mb-3">
        <div class="flex gap-2">
          <button type="submit" name="action" value="enable" class="btn">Enable</button>
          <button type="submit" name="action" value="disable" class="btn">Disable</button>
          <button type="submit" name="action" value="delete" class="btn btn-danger" id="deleteLlmSelected">Delete</button>
        </div>
        <div class="text-sm text-gray-600">Selected: <span id="llmSelectedCount">0</span></div>
      </div>
      <input type="hidden" name="ids" id="bulkLlmIds" value="">

      <table class="w-full text-sm text-left text-gray-600">
        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
          <tr>
            <th class="px-4 py-3"><input type="checkbox" id="selectAllLlm"></th>
            <th class="px-4 py-3">Name</th>
            <th class="px-4 py-3">Provider</th>
            <th class="px-4 py-3">Model</th>
            <th class="px-4 py-3">Description</th>
            <th class="px-4 py-3">Priority</th>
            <th class="px-4 py-3">Status</th>
            <th class="px-4 py-3">Default</th>
            <th class="px-4 py-3">Actions</th>
          </tr>
        </thead>
        <tbody>
        {% for llm in items %}
          <tr class="border-t">
            <td class="px-4 py-3"><input type="checkbox" name="selected" value="{{ llm.id }}" class="llmRowCheckbox"></td>
            <td class="px-4 py-3 text-gray-900 font-medium">{{ llm.name }}</td>
            <td class="px-4 py-3">
              <span class="text-xs px-2 py-1 rounded bg-blue-100 text-blue-700">{{ llm.provider }}</span>
            </td>
            <td class="px-4 py-3 font-mono text-xs">{{ llm.model_name }}</td>
            <td class="px-4 py-3 text-sm text-gray-700">{{ llm.description or '' }}</td>
            <td class="px-4 py-3 text-center">
              <span class="text-xs px-2 py-1 rounded bg-gray-100">{{ llm.priority }}</span>
            </td>
            <td class="px-4 py-3">
              <form method="post" action="/admin/llms/{{ llm.id }}/toggle" style="display:inline;">
                {% if llm.enabled %}
                  <button type="submit" class="text-xs px-2 py-1 rounded bg-green-100 text-green-700 hover:bg-green-200" title="Click to disable">enabled</button>
                {% else %}
                  <button type="submit" class="text-xs px-2 py-1 rounded bg-gray-200 text-gray-700 hover:bg-gray-300" title="Click to enable">disabled</button>
                {% endif %}
              </form>
            </td>
            <td class="px-4 py-3 text-center">
              {% if llm.is_default %}
                <span class="text-xs px-2 py-1 rounded bg-yellow-100 text-yellow-800">â˜… Default</span>
              {% else %}
                <form method="post" action="/admin/llms/{{ llm.id }}/set-default" style="display:inline;">
                  <button type="submit" class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-600 hover:bg-gray-200" title="Set as default">Set default</button>
                </form>
              {% endif %}
            </td>
            <td class="px-4 py-3">
              <div class="flex gap-1">
                <a href="/admin/llms/{{ llm.id }}/edit" class="text-xs px-2 py-1 rounded bg-blue-100 text-blue-700 hover:bg-blue-200">Edit</a>
                <form method="post" action="/admin/llms/{{ llm.id }}/delete" style="display:inline;" onsubmit="return confirm('Delete LLM \'{{ llm.name }}\'?')">
                  <button type="submit" class="text-xs px-2 py-1 rounded bg-red-100 text-red-700 hover:bg-red-200">Delete</button>
                </form>
              </div>
            </td>
          </tr>
        {% endfor %}
        {% if items|length == 0 %}
          <tr><td class="px-4 py-6 text-gray-500" colspan="9">No LLMs match the current filters.</td></tr>
        {% endif %}
        </tbody>
      </table>
    </form>
  </div>

  <script>
    const selectAllLlm = document.getElementById('selectAllLlm');
    const llmCheckboxes = document.querySelectorAll('.llmRowCheckbox');
    const llmCount = document.getElementById('llmSelectedCount');
    const deleteLlmBtn = document.getElementById('deleteLlmSelected');
    const bulkLlmIds = document.getElementById('bulkLlmIds');

    function updateLlmCount() {
      const checked = document.querySelectorAll('.llmRowCheckbox:checked');
      llmCount.textContent = checked.length;
      const ids = Array.from(checked).map(cb => cb.value).join(',');
      bulkLlmIds.value = ids;
    }

    if (selectAllLlm) {
      selectAllLlm.addEventListener('change', (e) => {
        llmCheckboxes.forEach(cb => cb.checked = e.target.checked);
        updateLlmCount();
      });
    }
    llmCheckboxes.forEach(cb => cb.addEventListener('change', updateLlmCount));

    function handleBulkSubmit(e) {
      const n = document.querySelectorAll('.llmRowCheckbox:checked').length;
      if (n === 0) {
        e.preventDefault();
        alert('No LLMs selected');
        return false;
      }
      
      const action = e.submitter.value;
      if (action === 'delete') {
        if (!confirm(`Delete ${n} selected LLM(s)? This cannot be undone.`)) {
          e.preventDefault();
          return false;
        }
      }
      return true;
    }
  </script>
{% endblock %}
