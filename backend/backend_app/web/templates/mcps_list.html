{% extends "base.html" %}
{% set title = "MCPs" %}
{% block content %}
<div class="container">
  <div class="flex items-end justify-between gap-3 flex-wrap mb-4">
    <div>
      <h1 class="h1">MCPs</h1>
      <p class="p-muted">Manage tool endpoints (MCP).</p>
    </div>
    <a href="/admin/mcps/add" class="btn btn-primary">Add MCP</a>
  </div>

  <div class="card card-pad" style="margin-bottom:12px;">
    <form method="get" class="grid grid-3">
      <div>
        <label class="block mb-1 text-xs font-medium text-gray-700">Search</label>
        <input name="q" value="{{ filters.q }}" placeholder="name or endpoint..." class="input">
      </div>
      <div>
        <label class="block mb-1 text-xs font-medium text-gray-700">Status</label>
        <select name="status" class="input">
          <option value="all" {{ "selected" if filters.status=="all" else "" }}>all</option>
          <option value="enabled" {{ "selected" if filters.status=="enabled" else "" }}>enabled</option>
          <option value="disabled" {{ "selected" if filters.status=="disabled" else "" }}>disabled</option>
        </select>
      </div>
      <div>
        <label class="block mb-1 text-xs font-medium text-gray-700">Tag</label>
        <input name="tag" value="{{ filters.tag }}" placeholder="tag..." class="input">
      </div>

      <div class="sm:col-span-3 flex gap-2">
        <button class="btn btn-primary">Apply</button>
        <a href="/admin/mcps" class="btn">Reset</a>
      </div>
    </form>
  </div>

  <div class="card tablewrap">
    <form method="post" action="/admin/mcps/bulk" id="bulkMcpForm">
      <div class="flex items-center justify-between mb-3">
        <div>
          <button type="submit" name="action" value="refresh" class="btn">Refresh tools</button>
          <button type="submit" name="action" value="delete" class="btn btn-danger" id="deleteMcpSelected">Delete MCPs</button>
        </div>
        <div class="text-sm text-gray-600">Selected: <span id="mcpSelectedCount">0</span></div>
      </div>

      <table class="w-full text-sm text-left text-gray-600">
        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
          <tr>
            <th class="px-4 py-3"><input type="checkbox" id="selectAllMcp"></th>
            <th class="px-4 py-3">Name</th>
            <th class="px-4 py-3">Endpoint</th>
            <th class="px-4 py-3">Kind</th>
            <th class="px-4 py-3">Status</th>
            <th class="px-4 py-3">Tags</th>
            <th class="px-4 py-3">Created</th>
          </tr>
        </thead>
        <tbody>
        {% for it in items %}
          <tr class="border-t">
            <td class="px-4 py-3"><input type="checkbox" name="selected" value="{{ it.id }}" class="mcpRowCheckbox"></td>
            <td class="px-4 py-3 text-gray-900 font-medium">{{ it.name }}</td>
            <td class="px-4 py-3 font-mono text-xs">{{ it.endpoint }}</td>
            <td class="px-4 py-3"><span class="text-xs px-2 py-1 rounded bg-gray-100">{{ it.kind }}</span></td>
            <td class="px-4 py-3">
              {% if it.status == "enabled" %}
                <span class="text-xs px-2 py-1 rounded bg-green-100 text-green-700">enabled</span>
              {% else %}
                <span class="text-xs px-2 py-1 rounded bg-gray-200 text-gray-700">disabled</span>
              {% endif %}
            </td>
            <td class="px-4 py-3">
              {% for t in it.tags %}
                <span class="text-xs px-2 py-1 rounded bg-gray-100 mr-1">{{ t }}</span>
              {% endfor %}
            </td>
            <td class="px-4 py-3 text-xs text-gray-500">{{ it.created_at }}</td>
          </tr>
        {% endfor %}
        {% if items|length == 0 %}
          <tr><td class="px-4 py-6 text-gray-500" colspan="7">No MCPs match the current filters.</td></tr>
        {% endif %}
        </tbody>
      </table>
    </form>
  </div>

  <script>
    const selectAllMcp = document.getElementById('selectAllMcp');
    const mcpCheckboxes = document.querySelectorAll('.mcpRowCheckbox');
    const mcpCount = document.getElementById('mcpSelectedCount');
    const deleteMcpBtn = document.getElementById('deleteMcpSelected');

    function updateMcpCount() {
      const n = document.querySelectorAll('.mcpRowCheckbox:checked').length;
      mcpCount.textContent = n;
    }

    if (selectAllMcp) {
      selectAllMcp.addEventListener('change', (e) => {
        mcpCheckboxes.forEach(cb => cb.checked = e.target.checked);
        updateMcpCount();
      });
    }
    mcpCheckboxes.forEach(cb => cb.addEventListener('change', updateMcpCount));

    if (deleteMcpBtn) {
      deleteMcpBtn.addEventListener('click', function(e) {
        const n = document.querySelectorAll('.mcpRowCheckbox:checked').length;
        if (n === 0) {
          e.preventDefault();
          alert('No MCPs selected');
          return false;
        }
        if (!confirm(`Delete ${n} selected MCP(s) and their related tools? This cannot be undone.`)) {
          e.preventDefault();
          return false;
        }
      });
    }
  </script>
{% endblock %}
