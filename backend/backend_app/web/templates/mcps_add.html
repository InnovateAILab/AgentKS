{% extends "base.html" %}
{% set title = "Add MCP" %}
{% block content %}
<div class="container" style="max-width:850px;">
  <div class="mb-6">
    <h1 class="h1">Add MCP</h1>
    <p class="p-muted">Register a tool/MCP endpoint (admin-only in this demo).</p>
  </div>

  <div class="card card-pad">
    <form method="post" action="/admin/mcps/add" class="space-y-4">
      <div>
        <label class="block mb-2 text-sm font-medium text-gray-900">Name</label>
        <input name="name" required class="input" placeholder="mcp-search">
      </div>

      <div>
        <label class="block mb-2 text-sm font-medium text-gray-900">Endpoint</label>
        <div class="flex gap-2">
          <input id="endpointInput" name="endpoint" required class="input" placeholder="http://mcp:8080">
          <button type="button" id="discoverBtn" class="btn">Discover</button>
        </div>
        <div id="discoverStatus" class="text-sm text-gray-600 mt-2"></div>
      </div>

      <div class="grid grid-3">
        <div>
          <label class="block mb-2 text-sm font-medium text-gray-900">Kind</label>
          <select name="kind" class="input">
            <option value="http">http</option>
            <option value="stdio">stdio</option>
            <option value="grpc">grpc</option>
          </select>
        </div>
        <div>
          <label class="block mb-2 text-sm font-medium text-gray-900">Status</label>
          <select name="status" class="input">
            <option value="enabled">enabled</option>
            <option value="disabled">disabled</option>
          </select>
        </div>
        <div>
          <label class="block mb-2 text-sm font-medium text-gray-900">Tags</label>
          <input name="tags" class="input" placeholder="tools, rag">
        </div>
      </div>

      <div>
        <label class="block mb-2 text-sm font-medium text-gray-900">Description</label>
        <input name="description" class="input" placeholder="Short description of this MCP">
      </div>

      <div class="grid grid-2">
        <div>
          <label class="block mb-2 text-sm font-medium text-gray-900">Resource</label>
          <input name="resource" class="input" placeholder="e.g. search, qa, extractor">
        </div>
        <div>
          <label class="block mb-2 text-sm font-medium text-gray-900">Context</label>
          <input name="context" class="input" placeholder="Optional notes: auth, headers, example usage">
        </div>
      </div>

      <div class="card card-pad">
        <h3 class="h3">Auth / Headers (optional)</h3>
        <p class="p-muted">Provide auth configuration for this MCP. You can supply a token or headers in JSON form.</p>
        <div>
          <label class="block mb-2 text-sm font-medium text-gray-900">Auth Type</label>
          <select name="auth_type" class="input">
            <option value="">none</option>
            <option value="bearer">bearer</option>
            <option value="basic">basic</option>
            <option value="header">header</option>
          </select>
        </div>
        <div>
          <label class="block mb-2 text-sm font-medium text-gray-900">Auth Token / Value</label>
          <input name="auth_token" class="input" placeholder="token or password">
        </div>
        <div>
          <label class="block mb-2 text-sm font-medium text-gray-900">Headers (JSON)</label>
          <textarea name="auth_headers" class="input" placeholder='{"X-Api-Key": "VALUE"}' rows="4"></textarea>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <button type="submit" class="btn btn-primary">Save</button>
        <a href="/admin/mcps" class="btn">Cancel</a>
      </div>
    </form>
  </div>
</div>
<script>
  (function(){
    const discoverBtn = document.getElementById('discoverBtn');
    const endpointInput = document.getElementById('endpointInput');
    const statusEl = document.getElementById('discoverStatus');
    if (!discoverBtn) return;

    discoverBtn.addEventListener('click', async function(){
      const endpoint = endpointInput.value && endpointInput.value.trim();
      if (!endpoint) {
        statusEl.textContent = 'Please enter an endpoint to discover.';
        return;
      }
      statusEl.textContent = 'Discovering...';

      // collect auth fields if present in the form
      const form = document.querySelector('form');
      const authType = form.querySelector('[name="auth_type"]')?.value || '';
      const authToken = form.querySelector('[name="auth_token"]')?.value || '';
      const authHeaders = form.querySelector('[name="auth_headers"]')?.value || '';

      const body = new URLSearchParams();
      body.append('endpoint', endpoint);
      if (authType) body.append('auth_type', authType);
      if (authToken) body.append('auth_token', authToken);
      if (authHeaders) body.append('auth_headers', authHeaders);

      try {
        const resp = await fetch('/admin/mcps/discover', { method: 'POST', body });
        const j = await resp.json();
        if (!j || !j.ok) {
          statusEl.textContent = j?.error || 'Discovery failed';
          return;
        }
        const data = j.data || {};
        // fill discovered fields if present
        if (data.name) form.querySelector('[name="name"]').value = data.name;
        if (data.description) form.querySelector('[name="description"]').value = data.description;
        if (data.resource) form.querySelector('[name="resource"]').value = data.resource;
        if (data.tags && Array.isArray(data.tags)) form.querySelector('[name="tags"]').value = data.tags.join(', ');
        statusEl.textContent = 'Discovered and filled fields.';
      } catch (err) {
        statusEl.textContent = 'Discovery error: ' + (err && err.message ? err.message : String(err));
      }
    });
  })();
</script>
{% endblock %}
