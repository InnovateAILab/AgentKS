{% extends "base.html" %}
{% set title = "Discovered URLs" %}
{% block content %}
<div class="container" style="max-width:1000px;">
  <div class="mb-6">
    <h1 class="h1">Discovered URLs</h1>
    <p class="p-muted">Select which URLs to process from: <strong>{{ parent.url }}</strong></p>
    <p class="text-xs text-gray-500 mt-2">Discovery status: <span class="px-2 py-1 rounded bg-blue-100 text-blue-700">{{ parent.discovery_status }}</span></p>
  </div>

  {% if parent.discovery_status == 'discovering' %}
  <div class="card card-pad mb-4 bg-yellow-50">
    <p class="text-yellow-800">⏳ Discovery in progress... Refresh this page in a few moments.</p>
  </div>
  {% elif parent.discovery_status == 'failed' %}
  <div class="card card-pad mb-4 bg-red-50">
    <p class="text-red-800">❌ Discovery failed. Please check the logs or try again.</p>
  </div>
  {% elif parent.discovery_status == 'discovered' and parent.discovered_urls|length == 0 %}
  <div class="card card-pad mb-4 bg-gray-50">
    <p class="text-gray-600">No related URLs were discovered from this page.</p>
  </div>
  {% endif %}

  {% if parent.discovered_urls|length > 0 %}
  <div class="card card-pad">
    <form method="post" action="/admin/urls/{{ parent.id }}/discover" id="discoverForm">
      <div class="flex items-center justify-between mb-4">
        <div>
          <button type="button" id="selectAll" class="btn">Select All</button>
          <button type="button" id="deselectAll" class="btn">Deselect All</button>
        </div>
        <div class="text-sm text-gray-600">Selected: <span id="selectedCount">0</span> / {{ parent.discovered_urls|length }}</div>
      </div>

      <div class="space-y-2 mb-6" style="max-height: 500px; overflow-y: auto;">
        {% for item in parent.discovered_urls %}
        <label class="flex items-start gap-3 p-3 border rounded hover:bg-gray-50 cursor-pointer">
          <input 
            type="checkbox" 
            name="selected_urls" 
            value="{{ item.url }}" 
            class="urlCheckbox mt-1 w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"
            {{ "checked" if item.selected else "" }}
          >
          <div class="flex-1">
            <div class="font-medium text-gray-900">{{ item.title }}</div>
            <div class="text-sm text-gray-500 break-all">{{ item.url }}</div>
          </div>
        </label>
        {% endfor %}
      </div>

      <div class="flex items-center gap-3">
        <button type="submit" class="btn btn-primary">Process Selected URLs</button>
        <a href="/admin/urls" class="btn">Back to URLs List</a>
      </div>
    </form>
  </div>
  {% endif %}

  <script>
    const checkboxes = document.querySelectorAll('.urlCheckbox');
    const selectedCount = document.getElementById('selectedCount');
    const selectAllBtn = document.getElementById('selectAll');
    const deselectAllBtn = document.getElementById('deselectAll');

    function updateCount() {
      const n = document.querySelectorAll('.urlCheckbox:checked').length;
      if (selectedCount) {
        selectedCount.textContent = n;
      }
    }

    if (selectAllBtn) {
      selectAllBtn.addEventListener('click', () => {
        checkboxes.forEach(cb => cb.checked = true);
        updateCount();
      });
    }

    if (deselectAllBtn) {
      deselectAllBtn.addEventListener('click', () => {
        checkboxes.forEach(cb => cb.checked = false);
        updateCount();
      });
    }

    checkboxes.forEach(cb => cb.addEventListener('change', updateCount));

    // Initialize count
    updateCount();
  </script>
</div>
{% endblock %}
