{% extends "base.html" %}
{% set title = "RAGs" %}
{% block content %}
<div class="container">
  <div class="mb-4">
    <h1 class="h1">RAGs</h1>
    <p class="p-muted">Collections / indexes overview with filters.</p>
  </div>

  <div class="card card-pad" style="margin-bottom:12px;">
    <form method="get" class="grid grid-4">
      <div>
        <label class="block mb-1 text-xs font-medium text-gray-700">Search</label>
        <input name="q" value="{{ filters.q }}" placeholder="name..." class="input">
      </div>
      <div>
        <label class="block mb-1 text-xs font-medium text-gray-700">Scope</label>
        <select name="scope" class="input">
          <option value="all" {{ "selected" if filters.scope=="all" else "" }}>all</option>
          <option value="global" {{ "selected" if filters.scope=="global" else "" }}>global</option>
          <option value="private" {{ "selected" if filters.scope=="private" else "" }}>private</option>
        </select>
      </div>
      <div>
        <label class="block mb-1 text-xs font-medium text-gray-700">Owner</label>
        <input name="owner" value="{{ '' if filters.owner=='all' else filters.owner }}" placeholder="user id..." class="input">
      </div>
      <div>
        <label class="block mb-1 text-xs font-medium text-gray-700">Embedding model</label>
        <select name="embed" class="input">
          <option value="all" {{ "selected" if filters.embed=="all" else "" }}>all</option>
          {% for m in embed_models %}
            <option value="{{ m }}" {{ "selected" if filters.embed==m else "" }}>{{ m }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="sm:col-span-4 flex gap-2">
        <button class="btn btn-primary">Apply</button>
        <a href="/admin/rags" class="btn">Reset</a>
      </div>
    </form>
  </div>

  <div class="card tablewrap">
    <form method="post" action="/admin/rags/bulk" id="bulkRagForm">
      <div class="flex items-center justify-between mb-3">
        <div>
          <button type="submit" name="action" value="refresh" class="btn">Refresh selected</button>
          <button type="submit" name="action" value="delete" class="btn btn-danger" id="deleteRagSelected">Delete selected</button>
        </div>
        <div class="text-sm text-gray-600">Selected: <span id="ragSelectedCount">0</span></div>
      </div>

      <table class="w-full text-sm text-left text-gray-600">
        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
          <tr>
            <th class="px-4 py-3"><input type="checkbox" id="selectAllRag"></th>
            <th class="px-4 py-3">Name</th>
            <th class="px-4 py-3">Scope</th>
            <th class="px-4 py-3">Owner</th>
            <th class="px-4 py-3">Doc count</th>
            <th class="px-4 py-3">Embedding</th>
            <th class="px-4 py-3">Updated</th>
          </tr>
        </thead>
        <tbody>
        {% for it in items %}
          <tr class="border-t">
            <td class="px-4 py-3"><input type="checkbox" name="selected" value="{{ it.id }}" class="ragRowCheckbox"></td>
            <td class="px-4 py-3 text-gray-900 font-medium">{{ it.name }}</td>
            <td class="px-4 py-3"><span class="text-xs px-2 py-1 rounded bg-gray-100">{{ it.scope }}</span></td>
            <td class="px-4 py-3 text-xs text-gray-700">{{ it.owner }}</td>
            <td class="px-4 py-3">{{ it.doc_count }}</td>
            <td class="px-4 py-3 text-xs">{{ it.embed_model }}</td>
            <td class="px-4 py-3 text-xs text-gray-500">{{ it.updated_at }}</td>
          </tr>
        {% endfor %}
        {% if items|length == 0 %}
          <tr><td class="px-4 py-6 text-gray-500" colspan="7">No RAGs match the current filters.</td></tr>
        {% endif %}
        </tbody>
      </table>
    </form>
  </div>

  <script>
    const selectAllRag = document.getElementById('selectAllRag');
    const ragCheckboxes = document.querySelectorAll('.ragRowCheckbox');
    const ragCount = document.getElementById('ragSelectedCount');
    const deleteRagBtn = document.getElementById('deleteRagSelected');

    function updateRagCount() {
      const n = document.querySelectorAll('.ragRowCheckbox:checked').length;
      ragCount.textContent = n;
    }

    if (selectAllRag) {
      selectAllRag.addEventListener('change', (e) => {
        ragCheckboxes.forEach(cb => cb.checked = e.target.checked);
        updateRagCount();
      });
    }
    ragCheckboxes.forEach(cb => cb.addEventListener('change', updateRagCount));

    if (deleteRagBtn) {
      deleteRagBtn.addEventListener('click', function(e) {
        const n = document.querySelectorAll('.ragRowCheckbox:checked').length;
        if (n === 0) {
          e.preventDefault();
          alert('No RAG groups selected');
          return false;
        }
        if (!confirm(`Delete ${n} selected RAG group(s) and their documents/associations? This cannot be undone.`)) {
          e.preventDefault();
          return false;
        }
      });
    }
  </script>
{% endblock %}
